import { useState, useEffect, useRef } from 'react';
import { useGame } from '../context/GameContext';
import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
import { Button } from './ui/button';
import { Select, Select              <span className="text-2xl font-bold text-gray-800 dark:text-white dark:bg-gradient-to-r dark:from-purple-300 dark:to-indigo-200 dark:bg-clip-text dark:text-transparent">
                {sessionType === 'focus' ? 'Focus Timer' : 'Break Time'}
              </span>
            </div>
            <div className="flex items-center gap-2">
              <Badge 
                variant="outline"
                className={`px-2.5 py-1 text-xs font-medium rounded-full ${
                  sessionType === 'focus' 
                    ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300 border border-purple-300 dark:border-purple-700/50' 
                    : 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 border border-green-300 dark:border-green-700/50'
                }`}
              >
                {!isRunning ? 'Ready' : sessionType === 'focus' ? 'Active' : 'Break'}
              </Badge>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setSoundEnabled(!soundEnabled)}
                className="h-8 w-8 rounded-full hover:bg-gray-100 dark:hover:bg-purple-800/50"
              >
                {soundEnabled ? (
                  <Volume2 size={18} className="text-gray-600 dark:text-gray-300" />
                ) : (
                  <VolumeX size={18} className="text-gray-500 dark:text-gray-400" />
                )}
              </Button>
            </div>m, SelectTrigger, SelectValue } from './ui/select';
import { Badge } from './ui/badge';
import { motion, AnimatePresence } from 'framer-motion';
import { Play, Pause, RotateCcw, Coffee, Brain, Volume2, VolumeX, Timer, Clock, Bell, Settings } from 'lucide-react';
import { toast } from 'sonner';

const FocusTimer = () => {
  const { actions } = useGame();
  
  // Timer states
  const [timeLeft, setTimeLeft] = useState(25 * 60); // Default 25 minutes in seconds
  const [isRunning, setIsRunning] = useState(false);
  const [sessionType, setSessionType] = useState<'focus' | 'break'>('focus');
  const [focusDuration, setFocusDuration] = useState(25); // In minutes
  const [breakDuration, setBreakDuration] = useState(5); // In minutes
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  // Reference to store the interval ID
  const intervalRef = useRef<number | null>(null);
  
  // Audio elements for notifications
  const focusCompleteSound = useRef<HTMLAudioElement | null>(null);
  const breakCompleteSound = useRef<HTMLAudioElement | null>(null);
  const tickSound = useRef<HTMLAudioElement | null>(null);
  
  // Initialize audio elements
  useEffect(() => {
    focusCompleteSound.current = new Audio('/sounds/complete.mp3');
    breakCompleteSound.current = new Audio('/sounds/break.mp3');
    tickSound.current = new Audio('/sounds/tick.mp3');
    
    // Set volumes
    if (focusCompleteSound.current) focusCompleteSound.current.volume = 0.5;
    if (breakCompleteSound.current) breakCompleteSound.current.volume = 0.5;
    if (tickSound.current) tickSound.current.volume = 0.2;
    
    return () => {
      // Clean up audio elements
      focusCompleteSound.current = null;
      breakCompleteSound.current = null;
      tickSound.current = null;
    };
  }, []);
  
  // Format time as MM:SS
  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };
  
  // Calculate progress percentage
  const calculateProgress = (): number => {
    const totalSeconds = sessionType === 'focus' ? focusDuration * 60 : breakDuration * 60;
    return ((totalSeconds - timeLeft) / totalSeconds) * 100;
  };
  
  // Start timer function
  const startTimer = () => {
    // Reset timeLeft based on session type
    setTimeLeft(sessionType === 'focus' ? focusDuration * 60 : breakDuration * 60);
    setIsRunning(true);
    
    // Clear any existing interval
    if (intervalRef.current) clearInterval(intervalRef.current);
    
    // Set up new interval
    intervalRef.current = window.setInterval(() => {
      setTimeLeft(prevTime => {
        // Play tick sound at certain intervals
        if (prevTime % 60 === 0 && prevTime > 0 && soundEnabled && tickSound.current) {
          tickSound.current.play().catch(err => console.error("Error playing tick sound:", err));
        }
        
        if (prevTime <= 1) {
          // Timer complete
          clearInterval(intervalRef.current!);
          handleTimerComplete();
          return 0;
        }
        return prevTime - 1;
      });
    }, 1000);
  };
  
  // Pause timer function
  const pauseTimer = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
    setIsRunning(false);
  };
  
  // Resume timer function
  const resumeTimer = () => {
    setIsRunning(true);
    
    intervalRef.current = window.setInterval(() => {
      setTimeLeft(prevTime => {
        if (prevTime <= 1) {
          clearInterval(intervalRef.current!);
          handleTimerComplete();
          return 0;
        }
        return prevTime - 1;
      });
    }, 1000);
  };
  
  // Reset timer function
  const resetTimer = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
    setIsRunning(false);
    setTimeLeft(sessionType === 'focus' ? focusDuration * 60 : breakDuration * 60);
  };
  
  // Handle timer completion
  const handleTimerComplete = () => {
    // Play appropriate sound
    if (soundEnabled) {
      if (sessionType === 'focus' && focusCompleteSound.current) {
        focusCompleteSound.current.play().catch(err => console.error("Error playing complete sound:", err));
      } else if (sessionType === 'break' && breakCompleteSound.current) {
        breakCompleteSound.current.play().catch(err => console.error("Error playing break sound:", err));
      }
    }
    
    // If focus session completed, reward XP
    if (sessionType === 'focus') {
      // Calculate XP based on focus duration (10 XP per 5 minutes)
      const xpEarned = Math.round(10 * (focusDuration / 5));
      
      // Add XP and log activity
      actions.addXP({
        amount: xpEarned,
        reason: `Completed ${focusDuration} min focus session`
      });
      
      // Log activity
      actions.logActivity({
        id: crypto.randomUUID(),
        type: 'focus_session',
        description: `Completed ${focusDuration} min focus session`,
        timestamp: new Date(),
        xpGained: xpEarned,
        healthChanged: 0
      });
      
      // Show notification
      toast.success(`Focus session complete! +${xpEarned} XP`, {
        description: `Great job focusing for ${focusDuration} minutes!`,
        duration: 5000,
      });
      
      // Switch to break session
      setSessionType('break');
      setTimeLeft(breakDuration * 60);
    } else {
      // Break session completed
      toast.success(`Break time's over!`, {
        description: `Ready for another focus session?`,
        duration: 5000,
      });
      
      // Switch back to focus session
      setSessionType('focus');
      setTimeLeft(focusDuration * 60);
    }
    
    // Stop the timer
    setIsRunning(false);
  };
  
  // Handle session duration change
  const handleFocusDurationChange = (value: string) => {
    const duration = parseInt(value);
    setFocusDuration(duration);
    
    // Update timeLeft if we're in a focus session
    if (sessionType === 'focus' && !isRunning) {
      setTimeLeft(duration * 60);
    }
  };
  
  // Handle break duration change
  const handleBreakDurationChange = (value: string) => {
    const duration = parseInt(value);
    setBreakDuration(duration);
    
    // Update timeLeft if we're in a break session
    if (sessionType === 'break' && !isRunning) {
      setTimeLeft(duration * 60);
    }
  };
  
  // Clean up interval on unmount
  useEffect(() => {
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, []);
  
  // Progress circle calculation
  const radius = 80;
  const circumference = 2 * Math.PI * radius;
  const progress = calculateProgress();
  const strokeDashoffset = circumference * (1 - progress / 100);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
    >
      <Card className="relative overflow-hidden bg-white dark:bg-gradient-to-br dark:from-purple-900/60 dark:to-indigo-900/80 border border-gray-200 dark:border-purple-800/50 text-gray-900 dark:text-white shadow-xl dark:shadow-purple-900/30 rounded-3xl">
        {/* Background pattern for visual interest */}
        <div className="absolute inset-0 opacity-[0.03] dark:opacity-5 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiM3QzNBRUQiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRjMC0yLjItMS44LTQtNC00cy00IDEuOC00IDQgMS44IDQgNCA0IDQtMS44IDQtNHptMC0xOGMwLTIuMi0xLjgtNC00LTRzLTQgMS44LTQgNCAxLjggNCA0IDQgNC0xLjggNC00em0wIDM2YzAtMi4yLTEuOC00LTQtNHMtNCAxLjgtNCA0IDEuOCA0IDQgNCA0LTEuOCA0LTR6Ii8+PC9nPjwvZz48L3N2Zz4=')]"></div>
        
        <CardHeader className="pb-2 bg-purple-50 dark:bg-purple-900/30 border-b border-gray-200 dark:border-purple-800/50">
          <CardTitle className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-gradient-to-br from-purple-100 to-indigo-200 dark:from-purple-700/60 dark:to-indigo-800/60 rounded-full shadow-md border border-purple-200 dark:border-purple-600/30">
                {sessionType === 'focus' ? (
                  <Brain size={24} className="text-purple-600 dark:text-purple-300" />
                ) : (
                  <Coffee size={24} className="text-green-600 dark:text-green-300" />
                )}
              </div>
              <span className="text-2xl font-bold text-gray-800 dark:text-white dark:bg-gradient-to-r dark:from-purple-300 dark:to-indigo-200 dark:bg-clip-text dark:text-transparent">
                {sessionType === 'focus' ? 'Focus Timer' : 'Break Time'}
              </span>
            </div>
            <Badge 
              variant="outline"
              className={`px-2.5 py-1 text-xs font-medium rounded-full ${
                sessionType === 'focus' 
                  ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300 border border-purple-300 dark:border-purple-700/50' 
                  : 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 border border-green-300 dark:border-green-700/50'
              }`}
            >
              {!isRunning ? 'Ready' : sessionType === 'focus' ? 'Active' : 'Break'}
            </Badge>
              ) : (
                <VolumeX size={20} className="text-gray-600 dark:text-gray-300" />
              )}
            </Button>
          </CardTitle>
        </CardHeader>
        
        <CardContent className="pb-8 pt-2">
          <div className="flex flex-col items-center justify-center">
            {/* Timer display with circle progress */}
            <div className="relative flex flex-col items-center justify-center mb-8">
              <svg width="200" height="200" className="transform -rotate-90">
                {/* Background circle */}
                <circle
                  cx="100"
                  cy="100"
                  r={radius}
                  fill="none"
                  stroke={sessionType === 'focus' ? 
                    "rgba(37, 99, 235, 0.1)" : 
                    "rgba(59, 130, 246, 0.1)"
                  }
                  strokeWidth="12"
                />
                
                {/* Progress circle */}
                <circle
                  cx="100"
                  cy="100"
                  r={radius}
                  fill="none"
                  stroke={sessionType === 'focus' ? 
                    "rgb(37, 99, 235)" : 
                    "rgb(59, 130, 246)"
                  }
                  strokeWidth="12"
                  strokeDasharray={circumference}
                  strokeDashoffset={strokeDashoffset}
                  strokeLinecap="round"
                />
              </svg>
              
              {/* Time display in the middle */}
              <div className="absolute flex flex-col items-center">
                <span className="text-6xl font-extrabold text-blue-600 dark:text-blue-300">
                  {formatTime(timeLeft)}
                </span>
                <span className="text-lg font-medium text-gray-500 dark:text-gray-300 mt-1">
                  {sessionType === 'focus' ? 'Focus Session' : 'Break'}
                </span>
              </div>
            </div>
            
            {/* Session duration controls */}
            <div className="grid grid-cols-2 gap-4 mb-8 w-full">
              <div className="space-y-2">
                <label htmlFor="focus-duration" className="block text-sm font-medium text-gray-600 dark:text-gray-300">
                  Focus Duration
                </label>
                <Select 
                  onValueChange={handleFocusDurationChange} 
                  value={focusDuration.toString()}
                  disabled={isRunning}
                >
                  <SelectTrigger id="focus-duration" className="w-full bg-white dark:bg-blue-900/40 border border-gray-300 dark:border-blue-700/60 rounded-xl">
                    <SelectValue placeholder="25 minutes" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="5">5 minutes</SelectItem>
                    <SelectItem value="10">10 minutes</SelectItem>
                    <SelectItem value="15">15 minutes</SelectItem>
                    <SelectItem value="20">20 minutes</SelectItem>
                    <SelectItem value="25">25 minutes</SelectItem>
                    <SelectItem value="30">30 minutes</SelectItem>
                    <SelectItem value="45">45 minutes</SelectItem>
                    <SelectItem value="60">60 minutes</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              
              <div className="space-y-2">
                <label htmlFor="break-duration" className="block text-sm font-medium text-gray-600 dark:text-gray-300">
                  Break Duration
                </label>
                <Select 
                  onValueChange={handleBreakDurationChange} 
                  value={breakDuration.toString()}
                  disabled={isRunning}
                >
                  <SelectTrigger id="break-duration" className="w-full bg-white dark:bg-blue-900/40 border border-gray-300 dark:border-blue-700/60 rounded-xl">
                    <SelectValue placeholder="5 minutes" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="3">3 minutes</SelectItem>
                    <SelectItem value="5">5 minutes</SelectItem>
                    <SelectItem value="10">10 minutes</SelectItem>
                    <SelectItem value="15">15 minutes</SelectItem>
                    <SelectItem value="20">20 minutes</SelectItem>
                    <SelectItem value="30">30 minutes</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            
            {/* Timer controls */}
            <div className="flex flex-wrap gap-4 justify-center w-full">
              {!isRunning ? (
                <>
                  <Button 
                    onClick={timeLeft === 0 ? startTimer : resumeTimer}
                    className="py-3 px-6 rounded-xl text-lg font-bold bg-blue-600 hover:bg-blue-500 text-white shadow-md border border-blue-500/50 transition-all hover:shadow-blue-500/20 flex items-center gap-2 flex-1"
                  >
                    <Play size={20} />
                    {timeLeft === 0 ? 'Start' : 'Resume'}
                  </Button>
                  
                  <Button 
                    onClick={resetTimer}
                    className="py-3 px-6 rounded-xl text-lg font-bold bg-gray-400 hover:bg-gray-500 text-white shadow-md border border-gray-500/50 transition-all hover:shadow-gray-500/20 flex items-center gap-2 flex-1"
                  >
                    <RotateCcw size={20} />
                    Reset
                  </Button>
                </>
              ) : (
                <Button 
                  onClick={pauseTimer}
                  className="py-3 px-6 rounded-xl text-lg font-bold bg-orange-500 hover:bg-orange-600 text-white shadow-md border border-orange-600/50 transition-all hover:shadow-orange-500/20 flex items-center gap-2 flex-grow"
                >
                  <Pause size={20} />
                  Pause
                </Button>
              )}
            </div>
          </div>
        </CardContent>
      </Card>
    </motion.div>
  );
};

export default FocusTimer;
